# EU Legal Document Recommender System

A sophisticated hybrid recommender system designed to match EU legal documents with user interests based on semantic similarity, document features, and user preferences. The system supports both standard and personalized recommendations, including document similarity search with client preference weighting.

## Architecture Overview

### Core Components

1. **Text Embedding (embeddings.py)**
   - Uses Legal-BERT (nlpaueb/legal-bert-base-uncased) for domain-specific semantic text understanding
   - 768-dimensional embeddings (model's native dimension)
   - Features:
     - Efficient batch processing
     - Embedding caching
     - GPU support when available

2. **Feature Processing (features.py)**
   - Handles categorical document attributes
   - Implements:
     - One-hot encoding for categorical features
     - Feature persistence and loading
     - Dynamic feature space adaptation

3. **Similarity Computation**
   - Hybrid similarity calculation combining:
     - Text embedding similarity (70% weight by default)
     - Categorical feature similarity (30% weight by default)
   - Uses Pinecone vector database for efficient similarity search
   - Supports metadata filtering and hybrid search
   - Configurable weights for text and categorical similarity

4. **Recommender System**
   - **Base Recommender (pinecone_recommender.py)**
     - Leverages Pinecone vector database for scalable similarity search
     - Provides configurable ranking parameters
     - Supports hybrid search combining embedding similarity with categorical features
     - Includes metadata filtering capabilities
     - Supports document similarity search with client preference weighting
   
   - **Personalized Recommender (personalized_recommender.py)**
     - Extends the base recommender with user profiles
     - Supports personalized recommendations based on user interests
     - Combines expert profiles, historical documents, and categorical preferences
     - Provides personalized document similarity search

### Input Features

1. **Text Features**
   - Document summaries (generated by our summarization pipeline)
   - Keywords (extracted using KeyBERT)
   - User interest descriptions

2. **Categorical Features**
   - Document Type (regulation, directive, decision)
   - Subject Matter
   - Legal Basis
   - Geographic Scope
   - Temporal Validity

## Installation

```bash
# Create and activate virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\\Scripts\\activate

# Install dependencies
pip install -r requirements.txt
```

## Usage

### Basic Usage

```python
from recommender.src.models.embeddings import BERTEmbedder
from recommender.src.models.features import FeatureProcessor
from recommender.src.models.pinecone_recommender import PineconeRecommender

# Initialize components
embedder = BERTEmbedder(model_name='nlpaueb/legal-bert-small-uncased')
feature_processor = FeatureProcessor({
    'type': ['regulation', 'directive', 'decision', 'other'],
    'subject': ['environment', 'transport', 'energy', 'finance', 'other'],
    'scope': ['EU-wide', 'member_states', 'third_countries', 'other'],
    'legal_basis': ['TFEU_114', 'TFEU_192', 'TFEU_194', 'other']
})

# Create Pinecone recommender
recommender = PineconeRecommender(
    api_key='your_pinecone_api_key',
    index_name='eu-legal-documents-legal-bert',
    embedder_model='nlpaueb/legal-bert-base-uncased',
    feature_processor=feature_processor,
    text_weight=0.7,
    categorical_weight=0.3
)

# Get recommendations
recommendations = recommender.get_recommendations(
    query_text='Environmental regulations for reducing greenhouse gas emissions',
    query_keywords=['climate', 'emissions', 'environment'],
    query_features={
        'type': 'regulation',
        'subject': 'environment',
        'scope': 'EU-wide',
        'legal_basis': 'TFEU_192'
    },
    top_k=5
)

# Display results
for i, rec in enumerate(recommendations):
    print(f"{i+1}. Document ID: {rec['id']} (Score: {rec['score']:.4f})")
    print(f"   Text Similarity: {rec['text_score']:.4f}")
    if rec.get('categorical_score'):
        print(f"   Categorical Similarity: {rec['categorical_score']:.4f}")
```

### Advanced Configuration

```python
# Enable GPU acceleration
embedder = BERTEmbedder(
    model_name='nlpaueb/legal-bert-base-uncased',
    device='cuda'
)

# Configure Pinecone with metadata filtering
recommender = PineconeRecommender(
    api_key='your_pinecone_api_key',
    index_name='eu-legal-documents-legal-bert',
    environment='gcp-starter',  # Or your specific Pinecone environment
    embedder_model='nlpaueb/legal-bert-base-uncased',
    feature_processor=feature_processor,
    text_weight=0.7,
    categorical_weight=0.3
)

# Use metadata filtering for more targeted results
filter_dict = {
    "metadata": {
        "type": "regulation",
        "year": {"$gte": 2015}  # Documents from 2015 or later
    }
}
```

## Performance Optimization

1. **Batch Processing**
   - Documents are processed in batches
   - Configurable batch size for memory management
   - Parallel processing where applicable

2. **Caching System**
   - Embeddings cache
   - Feature encoding cache
   - FAISS index persistence

3. **GPU Acceleration**
   - BERT model can run on GPU
   - FAISS GPU support available
   - Batch size optimization for GPU memory

## Evaluation Metrics

1. **Relevance Metrics**
   - Mean Reciprocal Rank (MRR)
   - Normalized Discounted Cumulative Gain (NDCG)
   - Precision@k
   - Recall@k

2. **Performance Metrics**
   - Processing time per document
   - Query response time
   - Memory usage
   - GPU utilization (if applicable)

## Personalized Recommendations

The system supports personalized recommendations through user profiles:

### User Profile Structure

User profiles consist of three main components:

1. **Expert Profile**: A textual description of the user's interests and expertise
2. **Historical Documents**: Documents the user has previously engaged with
3. **Categorical Preferences**: Specific preferences for document types, subjects, authors, etc.

Each component can be weighted differently to customize the personalization approach.

### Profile Creation Example

```python
from recommender.src.models.user_profile import UserProfile
from recommender.src.models.personalized_recommender import PersonalizedRecommender

# Create a user profile
user_profile = UserProfile(user_id="renewable_energy_client")

# Add expert profile description
user_profile.create_expert_profile(
    "Expert in renewable energy regulations, particularly interested in solar and wind energy policies, "
    "emission reduction targets, and sustainability requirements in the EU."
)

# Add historical documents the user has engaged with
user_profile.add_historical_document("32019R0943", engagement_score=0.9)  # Electricity Market Regulation
user_profile.add_historical_document("32018L2001", engagement_score=0.8)  # Renewable Energy Directive

# Set categorical preferences
user_profile.set_categorical_preferences({
    "document_type": {"regulation": 0.8, "directive": 0.9, "decision": 0.7},
    "subject_matters": {"energy": 1.0, "environment": 0.9, "climate": 0.9},
    "author": {"European Commission": 0.8, "European Parliament": 0.7},
    "form": {"legislative": 0.9, "non-legislative": 0.5}
})

# Set component weights
user_profile.set_component_weights({
    "expert_profile": 0.4,
    "historical_documents": 0.3,
    "categorical_preferences": 0.3
})
```

### Using the Personalized Recommender

```python
# Create personalized recommender
personalized_recommender = PersonalizedRecommender(
    api_key='your_pinecone_api_key',
    index_name='eu-legal-documents-legal-bert',
    embedder_model='nlpaueb/legal-bert-base-uncased'
)

# Add user profile
personalized_recommender.add_user_profile(user_profile)

# Get personalized recommendations by query
recommendations = personalized_recommender.get_personalized_recommendations(
    user_id="renewable_energy_client",
    query_text="Recent developments in offshore wind energy",
    top_k=5
)

# Get personalized document similarity recommendations
similar_docs = personalized_recommender.get_recommendations_by_id(
    document_id="32018L2001",  # Renewable Energy Directive
    top_k=5,
    include_categorical=True,
    client_preferences=user_profile.get_categorical_preferences()
)
```

### CLI Usage

```bash
# Get personalized recommendations by query
python cli.py recommend --query "renewable energy policy" --profile profiles/renewable_energy_client.json

# Get personalized recommendations by document ID
python cli.py recommend --document-id 32018L2001 --profile profiles/renewable_energy_client.json
```

## Recommendation Process

### Standard Recommendations

For standard (non-personalized) recommendations:

1. **Query Processing**: The user's text query is processed and converted to an embedding using Legal-BERT
2. **Vector Search**: The embedding is used to search the Pinecone index for semantically similar documents
3. **Categorical Matching**: Documents are also matched based on categorical features (document type, subject matter, etc.)
4. **Score Combination**: Text similarity and categorical similarity scores are combined with configurable weights
5. **Ranking**: Results are ranked by combined score and returned to the user

### Personalized Recommendations

For personalized recommendations:

1. **Profile Loading**: The user's profile is loaded, containing expert descriptions, historical documents, and preferences
2. **Composite Profile**: A composite profile embedding is created by combining:
   - Expert profile embedding (weighted by `expert_weight`)
   - Historical document embeddings (weighted by `historical_weight`)
   - Categorical preferences (weighted by `categorical_weight`)
3. **Query Blending**: If a query is provided, it's blended with the profile embedding:
   - Profile embedding (weighted by `profile_weight`)
   - Query embedding (weighted by `query_weight`)
4. **Vector Search**: The blended embedding is used to search for similar documents
5. **Preference Application**: Client preferences are applied to boost scores for preferred document types, subjects, etc.
6. **Result Ranking**: Documents are ranked by combined score and returned

### Document Similarity Search

For finding similar documents:

1. **Document Retrieval**: The specified document is retrieved from Pinecone
2. **Vector Extraction**: The document's embedding vector is extracted
3. **Categorical Features**: The document's categorical features are extracted
4. **Similar Documents**: Pinecone is queried to find documents with similar vectors
5. **Preference Application**: Client preferences are applied to boost scores for preferred documents
6. **Result Ranking**: Similar documents are ranked and returned